<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Management System</title>
    <link rel="stylesheet" href="css/custom-grid.css">
    <link rel="stylesheet" href="css/invoice-components.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            margin: 0;
            padding: 20px 0;
        }
        
        .invoice-header {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .invoice-form {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin: 0 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .invoice-actions {
            background: white;
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .invoice-actions .btn {
            margin: 0 10px;
            padding: 12px 30px;
            font-size: 16px;
        }
        
        .company-info {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .company-name {
            font-size: 28px;
            font-weight: 700;
            color: #333;
            margin-bottom: 10px;
        }
        
        .company-details {
            color: #666;
            line-height: 1.6;
        }
        
        .invoice-number {
            font-size: 24px;
            font-weight: 600;
            color: #007bff;
        }
        
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-draft {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-sent {
            background: #d4edda;
            color: #155724;
        }
        
        .status-paid {
            background: #d1ecf1;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Invoice Header -->
        <div class="invoice-header">
            <div class="company-info">
                <div class="company-name">Your Company Name</div>
                <div class="company-details">
                    123 Business Street, City, State 12345<br>
                    GSTIN: 29ABCDE1234F1Z5 | Phone: +91 98765 43210<br>
                    Email: info@yourcompany.com
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <h1>Tax Invoice</h1>
                </div>
                <div class="col-md-6 text-right">
                    <div class="invoice-number">INV-2024-0001</div>
                    <div class="status-badge status-draft">Draft</div>
                </div>
            </div>
        </div>

        <!-- Invoice Form -->
        <div class="invoice-form">
            <div class="row">
                <div class="col-md-6">
                    <h3 class="section-title">Bill To</h3>
                    <div id="customerSelector"></div>
                </div>
                <div class="col-md-6">
                    <h3 class="section-title">Invoice Details</h3>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Invoice Date:</label>
                                <input type="date" class="form-control" id="invoiceDate" value="2024-01-15">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Due Date:</label>
                                <input type="date" class="form-control" id="dueDate" value="2024-02-14">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Payment Terms:</label>
                        <select class="form-control" id="paymentTerms">
                            <option value="30">Net 30 Days</option>
                            <option value="15">Net 15 Days</option>
                            <option value="7">Net 7 Days</option>
                            <option value="0">Due on Receipt</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Invoice Items -->
        <div class="invoice-form">
            <h3 class="section-title">Invoice Items</h3>
            <div id="invoiceItems"></div>
        </div>

        <!-- GST Calculator Sidebar -->
        <div class="row">
            <div class="col-md-8">
                <div class="invoice-form">
                    <h3 class="section-title">Additional Information</h3>
                    <div class="form-group">
                        <label>Notes:</label>
                        <textarea class="form-control" rows="3" placeholder="Additional notes or terms..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Terms & Conditions:</label>
                        <textarea class="form-control" rows="3" placeholder="Payment terms and conditions..."></textarea>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div id="gstCalculator"></div>
            </div>
        </div>

        <!-- Invoice Actions -->
        <div class="invoice-actions">
            <button class="btn btn-outline" id="saveDraftBtn">Save as Draft</button>
            <button class="btn btn-secondary" id="previewBtn">Preview</button>
            <button class="btn btn-primary" id="generateBtn">Generate Invoice</button>
            <button class="btn btn-success" id="sendBtn">Send to Customer</button>
        </div>
    </div>

    <!-- Include Scripts -->
    <script src="js/invoice-utilities.js"></script>
    <script src="js/invoice-components.js"></script>
    
    <script>
        // Initialize the invoice form
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Customer Selector
            const customerSelector = new InvoiceComponents.CustomerSelector('#customerSelector', {
                onSelect: (customer) => {
                    console.log('Customer selected:', customer);
                    updateInvoiceData();
                },
                onNew: (name) => {
                    // Open customer creation modal
                    createNewCustomer(name);
                }
            });

            // Initialize Invoice Items Table
            const itemsTable = new InvoiceComponents.InvoiceItemsTable('#invoiceItems', {
                onUpdate: (items) => {
                    console.log('Items updated:', items);
                    updateInvoiceData();
                }
            });

            // Initialize GST Calculator
            const gstCalculator = new InvoiceComponents.GSTCalculator('#gstCalculator', {
                onCalculate: (result) => {
                    console.log('GST calculated:', result);
                }
            });

            // Form event handlers
            document.getElementById('invoiceDate').addEventListener('change', updateDueDate);
            document.getElementById('paymentTerms').addEventListener('change', updateDueDate);
            
            document.getElementById('saveDraftBtn').addEventListener('click', saveDraft);
            document.getElementById('previewBtn').addEventListener('click', previewInvoice);
            document.getElementById('generateBtn').addEventListener('click', generateInvoice);
            document.getElementById('sendBtn').addEventListener('click', sendInvoice);

            // Update due date based on invoice date and payment terms
            function updateDueDate() {
                const invoiceDate = document.getElementById('invoiceDate').value;
                const paymentTerms = parseInt(document.getElementById('paymentTerms').value);
                
                if (invoiceDate) {
                    const dueDate = InvoiceUtils.Date.getDueDate(invoiceDate, paymentTerms);
                    document.getElementById('dueDate').value = dueDate.toISOString().split('T')[0];
                }
            }

            // Create new customer
            function createNewCustomer(name) {
                InvoiceUtils.Modal.prompt(`
                    <h4>Add New Customer</h4>
                    <div class="form-group">
                        <label>Customer Name:</label>
                        <input type="text" class="form-control" id="newCustomerName" value="${name}">
                    </div>
                    <div class="form-group">
                        <label>GSTIN (Optional):</label>
                        <input type="text" class="form-control" id="newCustomerGSTIN" placeholder="29ABCDE1234F1Z5">
                    </div>
                    <div class="form-group">
                        <label>Email:</label>
                        <input type="email" class="form-control" id="newCustomerEmail">
                    </div>
                    <div class="form-group">
                        <label>Phone:</label>
                        <input type="tel" class="form-control" id="newCustomerPhone">
                    </div>
                    <div class="form-group">
                        <label>Address:</label>
                        <textarea class="form-control" id="newCustomerAddress" rows="3"></textarea>
                    </div>
                `, 'Add Customer').then((result) => {
                    if (result) {
                        const customerData = {
                            name: document.getElementById('newCustomerName').value,
                            gstin: document.getElementById('newCustomerGSTIN').value,
                            email: document.getElementById('newCustomerEmail').value,
                            phone: document.getElementById('newCustomerPhone').value,
                            address: document.getElementById('newCustomerAddress').value
                        };

                        // Validate customer data
                        const validation = InvoiceUtils.Validation.validateForm(customerData, {
                            name: ['required'],
                            gstin: ['gstin'],
                            email: ['email'],
                            phone: ['phone']
                        });

                        if (validation.isValid) {
                            const customerId = InvoiceUtils.Storage.saveCustomer(customerData);
                            customerSelector.selectCustomer({ ...customerData, id: customerId });
                        } else {
                            alert('Please fix the following errors:\n' + Object.values(validation.errors).flat().join('\n'));
                        }
                    }
                });
            }

            // Save draft
            function saveDraft() {
                const invoiceData = collectInvoiceData();
                const draftId = InvoiceUtils.Storage.saveDraft(invoiceData);
                
                InvoiceUtils.Modal.alert('Invoice draft saved successfully!', 'Draft Saved');
                console.log('Draft saved with ID:', draftId);
            }

            // Preview invoice
            function previewInvoice() {
                const invoiceData = collectInvoiceData();
                const validation = InvoiceUtils.Invoice.validateInvoice(invoiceData);
                
                if (!validation.isValid) {
                    alert('Please fix the following errors:\n' + Object.values(validation.errors).join('\n'));
                    return;
                }

                // Generate preview HTML
                const previewHTML = generateInvoiceHTML(invoiceData);
                
                // Show in modal
                const modal = new CustomModal({ size: 'xl' });
                modal.setTitle('Invoice Preview');
                modal.setBody(previewHTML);
                modal.setFooter(`
                    <button class="btn btn-outline modal-close">Close</button>
                    <button class="btn btn-primary" id="downloadPDF">Download PDF</button>
                `);
                
                modal.show();
                
                // Handle PDF download
                document.getElementById('downloadPDF').addEventListener('click', () => {
                    downloadInvoicePDF(invoiceData);
                });
            }

            // Generate invoice
            function generateInvoice() {
                const invoiceData = collectInvoiceData();
                const validation = InvoiceUtils.Invoice.validateInvoice(invoiceData);
                
                if (!validation.isValid) {
                    alert('Please fix the following errors:\n' + Object.values(validation.errors).join('\n'));
                    return;
                }

                // Generate invoice number if not exists
                if (!invoiceData.invoiceNumber) {
                    invoiceData.invoiceNumber = InvoiceUtils.Invoice.generateInvoiceNumber();
                }

                // Save invoice
                const invoiceId = InvoiceUtils.Storage.saveInvoice(invoiceData);
                
                InvoiceUtils.Modal.alert('Invoice generated successfully!', 'Invoice Generated');
                console.log('Invoice generated with ID:', invoiceId);
                
                // Update UI
                document.querySelector('.invoice-number').textContent = invoiceData.invoiceNumber;
                document.querySelector('.status-badge').textContent = 'Generated';
                document.querySelector('.status-badge').className = 'status-badge status-sent';
            }

            // Send invoice
            function sendInvoice() {
                const customer = customerSelector.getSelectedCustomer();
                
                if (!customer || !customer.email) {
                    alert('Please select a customer with a valid email address.');
                    return;
                }

                InvoiceUtils.Modal.confirm(
                    `Send invoice to ${customer.name} at ${customer.email}?`,
                    'Send Invoice'
                ).then((confirmed) => {
                    if (confirmed) {
                        // Simulate sending email
                        setTimeout(() => {
                            InvoiceUtils.Modal.alert('Invoice sent successfully!', 'Email Sent');
                            
                            // Update status
                            document.querySelector('.status-badge').textContent = 'Sent';
                            document.querySelector('.status-badge').className = 'status-badge status-sent';
                        }, 1000);
                    }
                });
            }

            // Collect all invoice data
            function collectInvoiceData() {
                const customer = customerSelector.getSelectedCustomer();
                const items = itemsTable.getItems();
                const totals = itemsTable.getTotals();
                
                return {
                    invoiceNumber: document.querySelector('.invoice-number').textContent,
                    invoiceDate: document.getElementById('invoiceDate').value,
                    dueDate: document.getElementById('dueDate').value,
                    paymentTerms: parseInt(document.getElementById('paymentTerms').value),
                    customer: customer,
                    items: items,
                    totals: totals,
                    notes: document.querySelector('textarea[placeholder*="Additional notes"]').value,
                    terms: document.querySelector('textarea[placeholder*="Payment terms"]').value,
                    createdAt: new Date().toISOString()
                };
            }

            // Update invoice data (called when customer or items change)
            function updateInvoiceData() {
                const customer = customerSelector.getSelectedCustomer();
                const items = itemsTable.getItems();
                
                // Auto-save draft every 30 seconds
                clearTimeout(window.autoSaveTimeout);
                window.autoSaveTimeout = setTimeout(() => {
                    if (customer && items.length > 0) {
                        saveDraft();
                    }
                }, 30000);
            }

            // Generate invoice HTML for preview
            function generateInvoiceHTML(invoiceData) {
                const { customer, items, totals } = invoiceData;
                
                return `
                    <div style="max-width: 800px; margin: 0 auto; padding: 20px; font-family: Arial, sans-serif;">
                        <div style="text-align: center; margin-bottom: 30px;">
                            <h1 style="color: #333; margin: 0;">Your Company Name</h1>
                            <p style="color: #666; margin: 5px 0;">123 Business Street, City, State 12345</p>
                            <p style="color: #666; margin: 5px 0;">GSTIN: 29ABCDE1234F1Z5 | Phone: +91 98765 43210</p>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; margin-bottom: 30px;">
                            <div>
                                <h2 style="color: #333; margin: 0 0 10px 0;">Tax Invoice</h2>
                                <p><strong>Invoice #:</strong> ${invoiceData.invoiceNumber}</p>
                                <p><strong>Date:</strong> ${InvoiceUtils.Date.formatIndianDate(invoiceData.invoiceDate)}</p>
                                <p><strong>Due Date:</strong> ${InvoiceUtils.Date.formatIndianDate(invoiceData.dueDate)}</p>
                            </div>
                            <div style="text-align: right;">
                                <h3 style="margin: 0 0 10px 0;">Bill To:</h3>
                                <p style="margin: 5px 0;"><strong>${customer?.name || 'N/A'}</strong></p>
                                ${customer?.gstin ? `<p style="margin: 5px 0;">GSTIN: ${customer.gstin}</p>` : ''}
                                ${customer?.address ? `<p style="margin: 5px 0;">${customer.address}</p>` : ''}
                                ${customer?.email ? `<p style="margin: 5px 0;">${customer.email}</p>` : ''}
                            </div>
                        </div>
                        
                        <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="border: 1px solid #ddd; padding: 12px; text-align: left;">Description</th>
                                    <th style="border: 1px solid #ddd; padding: 12px; text-align: center;">HSN/SAC</th>
                                    <th style="border: 1px solid #ddd; padding: 12px; text-align: center;">Qty</th>
                                    <th style="border: 1px solid #ddd; padding: 12px; text-align: right;">Rate</th>
                                    <th style="border: 1px solid #ddd; padding: 12px; text-align: right;">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${items.map(item => `
                                    <tr>
                                        <td style="border: 1px solid #ddd; padding: 12px;">${item.description}</td>
                                        <td style="border: 1px solid #ddd; padding: 12px; text-align: center;">${item.hsnSac}</td>
                                        <td style="border: 1px solid #ddd; padding: 12px; text-align: center;">${item.quantity} ${item.unit}</td>
                                        <td style="border: 1px solid #ddd; padding: 12px; text-align: right;">${InvoiceUtils.Currency.formatINR(item.rate)}</td>
                                        <td style="border: 1px solid #ddd; padding: 12px; text-align: right;">${InvoiceUtils.Currency.formatINR(item.quantity * item.rate)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        
                        <div style="text-align: right; margin-bottom: 30px;">
                            <p><strong>Subtotal: ${InvoiceUtils.Currency.formatINR(totals.subtotal)}</strong></p>
                            <p><strong>Total GST: ${InvoiceUtils.Currency.formatINR(totals.totalGST)}</strong></p>
                            <p style="font-size: 18px; color: #28a745;"><strong>Grand Total: ${InvoiceUtils.Currency.formatINR(totals.grandTotal)}</strong></p>
                            <p style="font-style: italic;">${totals.grandTotalInWords}</p>
                        </div>
                        
                        ${invoiceData.notes ? `
                            <div style="margin-bottom: 20px;">
                                <h4>Notes:</h4>
                                <p>${invoiceData.notes}</p>
                            </div>
                        ` : ''}
                        
                        ${invoiceData.terms ? `
                            <div>
                                <h4>Terms & Conditions:</h4>
                                <p>${invoiceData.terms}</p>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            // Download invoice as PDF (placeholder - would need PDF library)
            function downloadInvoicePDF(invoiceData) {
                // This would typically use a PDF generation library like jsPDF
                alert('PDF download functionality would be implemented here using a PDF library like jsPDF or Puppeteer.');
            }

            // Initialize with current date
            updateDueDate();
        });
    </script>
</body>
</html>
